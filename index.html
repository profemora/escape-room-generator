<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Escape Room Gen - FIX</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_fix_key') || '');
            const [isAuth, setIsAuth] = useState(!!localStorage.getItem('gemini_fix_key'));
            const [text, setText] = useState('');
            const [status, setStatus] = useState('IDLE');

            const handleAuth = () => {
                const cleanKey = apiKey.trim();
                if (cleanKey.startsWith('AIza')) {
                    localStorage.setItem('gemini_fix_key', cleanKey);
                    setIsAuth(true);
                } else {
                    alert("Errore: La chiave deve iniziare con AIza. Ricontrolla di averla copiata bene.");
                }
            };

            const generate = async () => {
                setStatus('GENERATING');
                try {
                    // Usiamo gemini-1.5-flash che Ã¨ quello standard gratuito
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Genera una escape room in inglese su: " + text }] }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }
                    
                    setStatus('SUCCESS');
                } catch (e) {
                    alert("Errore tecnico: " + e.message);
                    setStatus('IDLE');
                }
            };

            if (!isAuth) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="bg-white p-8 rounded-2xl shadow-lg border border-blue-100">
                            <h2 className="text-xl font-bold mb-4">Configurazione</h2>
                            <input 
                                type="text" 
                                className="w-full p-2 border rounded mb-4" 
                                placeholder="Incolla chiave AIza..."
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                            />
                            <button onClick={handleAuth} class="w-full bg-blue-500 text-white p-2 rounded">Salva Chiave</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-10 max-w-2xl mx-auto">
                    <textarea 
                        className="w-full h-40 p-4 border rounded-xl"
                        placeholder="Incolla qui..."
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                    />
                    <button 
                        onClick={generate}
                        className="w-full mt-4 bg-pink-400 text-white p-4 rounded-full font-bold"
                        disabled={status === 'GENERATING'}
                    >
                        {status === 'GENERATING' ? 'Generazione in corso...' : 'Genera Gioco'}
                    </button>
                    {status === 'SUCCESS' && <p className="mt-4 text-green-600 text-center font-bold">Gioco generato correttamente!</p>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>