<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Generator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#FFF5E4]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [isAuth, setIsAuth] = useState(!!localStorage.getItem('gemini_key'));
            const [text, setText] = useState('');
            const [status, setStatus] = useState('IDLE');
            const [downloadUrl, setDownloadUrl] = useState(null);

            const handleAuth = () => {
                if (apiKey.startsWith('AIza')) {
                    localStorage.setItem('gemini_key', apiKey);
                    setIsAuth(true);
                } else {
                    alert("Chiave non valida!");
                }
            };

            const generateGame = async () => {
                setStatus('GENERATING');
                try {
                    // Chiamata diretta a Gemini 1.5 Flash (usando la tua logica)
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Agisci come esperto creatore di contenuti. Genera una Escape Room educativa basata su questo testo: " + text }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const result = await response.json();
                    const gameData = JSON.parse(result.candidates[0].content.parts[0].text);

                    // Trasformazione in HTML per lo studente
                    const blob = new Blob([`<!DOCTYPE html><html><body><h1>${gameData.title}</h1><p>${gameData.introText}</p></body></html>`], { type: 'text/html' });
                    setDownloadUrl(URL.createObjectURL(blob));
                    setStatus('SUCCESS');
                } catch (e) {
                    console.error(e);
                    alert("Errore durante la generazione. Verifica la tua chiave API.");
                    setStatus('IDLE');
                }
            };

            if (!isAuth) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                            <h2 className="text-2xl font-bold mb-4">Inserisci API Key</h2>
                            <input 
                                type="password" 
                                className="w-full p-3 border-2 rounded-xl mb-4 text-center outline-none"
                                placeholder="AIzaSy..."
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                            />
                            <button onClick={handleAuth} className="w-full py-3 bg-blue-400 text-white font-bold rounded-full">Attiva</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto p-8">
                    <h1 className="text-3xl font-bold text-center mb-8">Escape Room Generator</h1>
                    <div className="bg-white p-8 rounded-3xl shadow-lg border-b-8 border-pink-200">
                        {status === 'IDLE' && (
                            <>
                                <textarea 
                                    className="w-full h-64 p-4 bg-gray-50 rounded-xl mb-4 outline-none"
                                    placeholder="Incolla qui il testo della lezione..."
                                    value={text}
                                    onChange={(e) => setText(e.target.value)}
                                />
                                <button onClick={generateGame} className="w-full py-4 bg-pink-300 text-white font-bold rounded-full">Genera Gioco âœ¨</button>
                            </>
                        )}
                        {status === 'GENERATING' && <div className="text-center py-10 animate-pulse text-xl">L'IA sta creando il gioco...</div>}
                        {status === 'SUCCESS' && (
                            <div className="text-center py-10">
                                <h2 className="text-2xl font-bold mb-6 text-green-500">Gioco Creato!</h2>
                                <a href={downloadUrl} download="escape-room.html" className="inline-block py-4 px-10 bg-blue-400 text-white font-bold rounded-full shadow-md">
                                    Scarica File Studenti
                                </a>
                                <button onClick={() => setStatus('IDLE')} className="block mx-auto mt-6 text-sm text-gray-400 underline">Crea un'altra</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>